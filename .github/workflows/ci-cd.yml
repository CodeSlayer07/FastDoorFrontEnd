name: CI for Vite + React App

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Build the app
        run: npm run build

      - name: Check contents of dist
        run: ls -la dist

      - name: Deploy to Server
        uses: appleboy/ssh-action@v0.1.2
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            echo "üöÄ –ù–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è"
            
            cd ~/mrDverkinFront
            
            echo "üîÅ –°–±—Ä–æ—Å –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π"
            git reset --hard HEAD
            git clean -fd
            
            echo "üì• –ü–æ–ª—É—á–∞–µ–º —Å–≤–µ–∂–∏–π –∫–æ–¥"
            git pull origin master
            if [ $? -ne 0 ]; then echo "‚ùå git pull –Ω–µ —É–¥–∞–ª—Å—è"; exit 1; fi
            
            echo "üßπ –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥-—Ñ–∞–π–ª—ã"
            sudo rm -f /var/www/frontend/index.html
            sudo rm -rf /var/www/frontend/assets
            
            echo "üì¶ –ö–æ–ø–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã"
            sudo cp -r ~/mrDverkinFront/dist/* /var/www/frontend/
            
            echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx"
            sudo nginx -t
            if [ $? -ne 0 ]; then echo "‚ùå –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥–µ nginx"; exit 1; fi
            
            echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ nginx"
            sudo systemctl restart nginx
            if [ $? -ne 0 ]; then echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å nginx"; exit 1; fi
            
            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ!"